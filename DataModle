using Aspose.Words;
using Aspose.Words.Drawing;
using Aspose.Words.Replacing;
using DLCA;
using Dumpify;
using Newtonsoft.Json.Linq;
using SQLitePCL;
using System;
using System.Collections;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Collections.Generic;
using System.Collections.Immutable;
using System.Data;
using System.Data.SQLite;
using System.Data.SqlTypes;
using System.Dynamic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection.Metadata;
using System.Runtime.Loader;
using System.Security.Cryptography;
using System.Security.Policy;
using System.Text;
using System.Threading.Tasks;
using System.Xml.Linq;






namespace DLCA
{

    //本地数据提交信息类//
    public class PostLocalDataClass
    {
        public string random21 { get; set; } = "";
        public string DanWeiMingCheng { get; set; } = "";
        public string DangPaiMingCheng { get; set; } = "";
    }


    //获取退休年龄的请求参数//
    public class RequestTuiXiuClass
    {
        public string random21 { get; set; } = "";
        public string XingBie { get; set; } = "";
        public string GanBuLeiXing { get; set; } = "";
        public string ChuShengRiQi { get; set; } = "";
        public string OutTuiXiuRiQi { get; set; } = "";
        public string OutTuiXiuNianLing { get; set; } = "";
        public string OutTuiXiuNianYue { get; set; } = "";
    }


    public class PersonDto
    {
        public string XingMing { get; set; } = "";
        public string XingBie { get; set; } = "";
        public string ChuShengNianYue { get; set; } = "";
        public string MinZu { get; set; } = "";
        public string JiGuan { get; set; } = "";
        public string ChuShengDi { get; set; } = "";
        public string RuDangShiJian { get; set; } = "";
        public string CanJiaGongZuoShiJian { get; set; } = "";
        public string JianKangZhuangKuang { get; set; } = "";
        public string ZhuanYeJiShuZhiWu { get; set; } = "";
        public string ShuXiZhuanYeYouHeZhuanChang { get; set; } = "";

        public string QuanRiZhiJiaoYu_XueLi { get; set; } = "";
        public string QuanRiZhiJiaoYu_XueWei { get; set; } = "";
        public string QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi { get; set; } = "";
        public string QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi { get; set; } = "";

        public string ZaiZhiJiaoYu_XueLi { get; set; } = "";
        public string ZaiZhiJiaoYu_XueWei { get; set; } = "";
        public string ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi { get; set; } = "";
        public string ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi { get; set; } = "";

        public string XianRenZhiWu { get; set; } = "";
        public string NiRenZhiWu { get; set; } = "";
        public string NiMianZhiWu { get; set; } = "";

        public string JianLi { get; set; } = "";
        public string JiangChengQingKuang { get; set; } = "";
        public string NianDuKaoHeJieGuo { get; set; } = "";
        public string RenMianLiYou { get; set; } = "";

        public string JiaTingChengYuanJson { get; set; } = ""; // 家庭成员 JSON 字符串

        public string ChengBaoDanWei { get; set; } = "";
        public string JiSuanNianLingShiJian { get; set; } = "";
        public string TianBiaoShiJian { get; set; } = "";
        public string TianBiaoRen { get; set; } = "";
        public string ShenFenZheng { get; set; } = "";
        public string ZhaoPianBase64 { get; set; } = "";
        public string Version { get; set; } = "";

        // 其他字段可根据需要添加//
        public string DanWeiMingCheng { get; set; } = "";
        public string DangPaiMingCheng { get; set; } = "";
    }


    public static class XmlPersonParser
    {
        public static PersonDto ParseFromXml(string filePath)
        {
            XDocument doc = XDocument.Load(filePath);
            var person = doc.Element("Person");
            if (person == null)
                throw new Exception("未找到 <Person> 节点");

            var dto = new PersonDto
            {
                XingMing = person.Element("XingMing")?.Value ?? "",
                XingBie = person.Element("XingBie")?.Value ?? "",
                ChuShengNianYue = person.Element("ChuShengNianYue")?.Value ?? "",
                MinZu = person.Element("MinZu")?.Value ?? "",
                JiGuan = person.Element("JiGuan")?.Value ?? "",
                ChuShengDi = person.Element("ChuShengDi")?.Value ?? "",
                RuDangShiJian = person.Element("RuDangShiJian")?.Value ?? "",
                CanJiaGongZuoShiJian = person.Element("CanJiaGongZuoShiJian")?.Value ?? "",
                JianKangZhuangKuang = person.Element("JianKangZhuangKuang")?.Value ?? "",
                ZhuanYeJiShuZhiWu = person.Element("ZhuanYeJiShuZhiWu")?.Value ?? "",
                ShuXiZhuanYeYouHeZhuanChang = person.Element("ShuXiZhuanYeYouHeZhuanChang")?.Value ?? "",

                QuanRiZhiJiaoYu_XueLi = person.Element("QuanRiZhiJiaoYu_XueLi")?.Value ?? "",
                QuanRiZhiJiaoYu_XueWei = person.Element("QuanRiZhiJiaoYu_XueWei")?.Value ?? "",
                QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi = person.Element("QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi")?.Value ?? "",
                QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi = person.Element("QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi")?.Value ?? "",

                ZaiZhiJiaoYu_XueLi = person.Element("ZaiZhiJiaoYu_XueLi")?.Value ?? "",
                ZaiZhiJiaoYu_XueWei = person.Element("ZaiZhiJiaoYu_XueWei")?.Value ?? "",
                ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi = person.Element("ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi")?.Value ?? "",
                ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi = person.Element("ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi")?.Value ?? "",

                XianRenZhiWu = person.Element("XianRenZhiWu")?.Value ?? "",
                NiRenZhiWu = person.Element("NiRenZhiWu")?.Value ?? "",
                NiMianZhiWu = person.Element("NiMianZhiWu")?.Value ?? "",

                JianLi = person.Element("JianLi")?.Value ?? "",
                JiangChengQingKuang = person.Element("JiangChengQingKuang")?.Value ?? "",
                NianDuKaoHeJieGuo = person.Element("NianDuKaoHeJieGuo")?.Value ?? "",
                RenMianLiYou = person.Element("RenMianLiYou")?.Value ?? "",

                ChengBaoDanWei = person.Element("ChengBaoDanWei")?.Value ?? "",
                JiSuanNianLingShiJian = person.Element("JiSuanNianLingShiJian")?.Value ?? "",
                TianBiaoShiJian = person.Element("TianBiaoShiJian")?.Value ?? "",
                TianBiaoRen = person.Element("TianBiaoRen")?.Value ?? "",
                ShenFenZheng = person.Element("ShenFenZheng")?.Value ?? "",
                ZhaoPianBase64 = person.Element("ZhaoPian")?.Value ?? "",
                Version = person.Element("Version")?.Value ?? ""
            };

            // 家庭成员 → JSON 字符串
            var family = person.Element("JiaTingChengYuan")?
                .Elements("Item")
                .Select(m => new
                {
                    ChengWei = m.Element("ChengWei")?.Value ?? "",
                    XingMing = m.Element("XingMing")?.Value ?? "",
                    ChuShengRiQi = m.Element("ChuShengRiQi")?.Value ?? "",
                    ZhengZhiMianMao = m.Element("ZhengZhiMianMao")?.Value ?? "",
                    GongZuoDanWeiJiZhiWu = m.Element("GongZuoDanWeiJiZhiWu")?.Value ?? ""
                }).ToList();

            dto.JiaTingChengYuanJson = family == null ? "" : JsonConvert.SerializeObject(family);

            return dto;
        }
    }


    internal class DataModle
    {

        public DbHelpers DBHelpers;
        public System.Data.SQLite.SQLiteConnection Connection = null;

        public DataModle()
        {
            DBHelpers = new DbHelpers();
            string TemDbPath = GetDwDbPathRecursive();
            string TemError = "";
            if (!string.IsNullOrEmpty(TemDbPath))
            {
                try
                {
                    Connection = DBHelpers.GetPhysicalDbConnection(TemDbPath);
                }
                catch (Exception ex)
                { 
                    TemError = ex.Message;
                    Connection = null;
                }
            }
            if( (Connection == null) || TemError!="")
            {
                MSG.WriteLine($@"打开数据文件失败:{TemError},路径:{TemDbPath}");
            }
        }

        ~DataModle()
        {
            if (Connection != null)
            {
                Connection.Close();
                Connection.Dispose();
            }
        }


        private static string GetDwDbPathRecursive()
        {
            const string TemName = "dw.db";
            string dir = Path.GetFullPath(AppDomain.CurrentDomain.BaseDirectory.TrimEnd(Path.DirectorySeparatorChar));
            while (!string.IsNullOrEmpty(dir))
            {
                string candidate = Path.Combine(dir, TemName);
                //MSG.WriteLine($@"尝试目录:{candidate}");
                if (File.Exists(candidate))
                {
                    return candidate;
                }

                dir = Directory.GetParent(dir)?.FullName;
            }
            return "";
        }



        public void fun_TestData()
        {
            SQLiteCommand cmd = new SQLiteCommand(Connection);
            SQLiteHelper sh = new SQLiteHelper(cmd);
            sh.Select("select * from kslist;").Dump(tableConfig: new() { MaxCollectionCount = 5, ShowRowSeparators = true });
            sh.GetTableList().Dump();
            sh.ShowDatabase().Dump();
            cmd.Dispose();
        }


        public void UpsertKslist(PersonDto p)
        {
            if (Connection == null)
            {
                MSG.WriteLine("数据库连接为空，无法导入。");
                return;
            }

            // 1. 先查 ShenFenZheng 是否存在
            long? existingId = null;
            using (var checkCmd = new SQLiteCommand("SELECT myid FROM kslist WHERE ShenFenZheng = @sfz LIMIT 1;", Connection))
            {
                checkCmd.Parameters.AddWithValue("@sfz", p.ShenFenZheng ?? "");
                var obj = checkCmd.ExecuteScalar();
                if (obj != null && obj != DBNull.Value)
                    existingId = (long)(obj);
            }

            string now = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            byte[] photoBytes = null;
            if (!string.IsNullOrWhiteSpace(p.ZhaoPianBase64))
            {
                try { photoBytes = Convert.FromBase64String(p.ZhaoPianBase64); }
                catch { photoBytes = null; }
            }

            if (existingId == null)
            {
                // 2. 不存在 → INSERT
                using (var cmd = new SQLiteCommand(Connection))
                {
                    cmd.CommandText = @"
                    INSERT INTO kslist (
                      ShenFenZheng, XingMing, XingBie, ChuShengNianYue, MinZu, JiGuan, ChuShengDi,
                      RuDangShiJian, CanJiaGongZuoShiJian, JianKangZhuangKuang, ZhuanYeJiShuZhiWu,
                      ShuXiZhuanYeYouHeZhuanChang, QuanRiZhiJiaoYu_XueLi, QuanRiZhiJiaoYu_XueWei,
                      QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi, QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi,
                      ZaiZhiJiaoYu_XueLi, ZaiZhiJiaoYu_XueWei, ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi,
                      ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi, XianRenZhiWu, NiRenZhiWu, NiMianZhiWu,
                      JianLi, JiangChengQingKuang, NianDuKaoHeJieGuo, RenMianLiYou, JiaTingChengYuan,
                      ChengBaoDanWei, JiSuanNianLingShiJian, TianBiaoShiJian, TianBiaoRen,
                      ZhaoPian, Version, NianLing, XiuGaiShiJian, ChuangJianShiJian, DanWeiMingCheng, DangPaiMingCheng
                    ) VALUES (
                      @ShenFenZheng, @XingMing, @XingBie, @ChuShengNianYue, @MinZu, @JiGuan, @ChuShengDi,
                      @RuDangShiJian, @CanJiaGongZuoShiJian, @JianKangZhuangKuang, @ZhuanYeJiShuZhiWu,
                      @ShuXiZhuanYeYouHeZhuanChang, @QuanRiZhiJiaoYu_XueLi, @QuanRiZhiJiaoYu_XueWei,
                      @QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi, @QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi,
                      @ZaiZhiJiaoYu_XueLi, @ZaiZhiJiaoYu_XueWei, @ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi,
                      @ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi, @XianRenZhiWu, @NiRenZhiWu, @NiMianZhiWu,
                      @JianLi, @JiangChengQingKuang, @NianDuKaoHeJieGuo, @RenMianLiYou, @JiaTingChengYuan,
                      @ChengBaoDanWei, @JiSuanNianLingShiJian, @TianBiaoShiJian, @TianBiaoRen,
                      @ZhaoPian, @Version, @NianLing, @XiuGaiShiJian, @ChuangJianShiJian, @DanWeiMingCheng, @DangPaiMingCheng
                    );";
                    FillCommonParameters(cmd, p, photoBytes, now, now);
                    cmd.ExecuteNonQuery();
                }
            }
            else
            {
                // 3. 已存在 → UPDATE
                using (var cmd = new SQLiteCommand(Connection))
                {
                    cmd.CommandText = @"
                    UPDATE kslist SET
                      XingMing=@XingMing, XingBie=@XingBie, ChuShengNianYue=@ChuShengNianYue,
                      MinZu=@MinZu, JiGuan=@JiGuan, ChuShengDi=@ChuShengDi,
                      RuDangShiJian=@RuDangShiJian, CanJiaGongZuoShiJian=@CanJiaGongZuoShiJian,
                      JianKangZhuangKuang=@JianKangZhuangKuang, ZhuanYeJiShuZhiWu=@ZhuanYeJiShuZhiWu,
                      ShuXiZhuanYeYouHeZhuanChang=@ShuXiZhuanYeYouHeZhuanChang,
                      QuanRiZhiJiaoYu_XueLi=@QuanRiZhiJiaoYu_XueLi,
                      QuanRiZhiJiaoYu_XueWei=@QuanRiZhiJiaoYu_XueWei,
                      QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi=@QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi,
                      QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi=@QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi,
                      ZaiZhiJiaoYu_XueLi=@ZaiZhiJiaoYu_XueLi,
                      ZaiZhiJiaoYu_XueWei=@ZaiZhiJiaoYu_XueWei,
                      ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi=@ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi,
                      ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi=@ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi,
                      XianRenZhiWu=@XianRenZhiWu, NiRenZhiWu=@NiRenZhiWu, NiMianZhiWu=@NiMianZhiWu,
                      JianLi=@JianLi, JiangChengQingKuang=@JiangChengQingKuang,
                      NianDuKaoHeJieGuo=@NianDuKaoHeJieGuo, RenMianLiYou=@RenMianLiYou,
                      JiaTingChengYuan=@JiaTingChengYuan, ChengBaoDanWei=@ChengBaoDanWei,
                      JiSuanNianLingShiJian=@JiSuanNianLingShiJian, TianBiaoShiJian=@TianBiaoShiJian,
                      TianBiaoRen=@TianBiaoRen, ZhaoPian=@ZhaoPian, Version=@Version,
                      NianLing=@NianLing, XiuGaiShiJian=@XiuGaiShiJian,
                      DanWeiMingCheng=@DanWeiMingCheng, DangPaiMingCheng=@DangPaiMingCheng
                    WHERE ShenFenZheng=@ShenFenZheng;";
                    FillCommonParameters(cmd, p, photoBytes, now, null);
                    cmd.Parameters.AddWithValue("@ShenFenZheng", p.ShenFenZheng ?? "");
                    cmd.ExecuteNonQuery();
                }
            }
        }

        private void FillCommonParameters(SQLiteCommand cmd, PersonDto p, byte[] photoBytes, string xiuGai, string? chuangJian)
        {
            cmd.Parameters.AddWithValue("@ShenFenZheng", p.ShenFenZheng ?? "");
            cmd.Parameters.AddWithValue("@XingMing", p.XingMing ?? "");
            cmd.Parameters.AddWithValue("@XingBie", p.XingBie ?? "");

            // 日期字段统一格式化
            cmd.Parameters.AddWithValue("@ChuShengNianYue", DateNormalizer.NormalizeChuShengNianYue(p.ChuShengNianYue));
            cmd.Parameters.AddWithValue("@RuDangShiJian", DateNormalizer.NormalizeChuShengNianYue(p.RuDangShiJian));
            cmd.Parameters.AddWithValue("@CanJiaGongZuoShiJian", DateNormalizer.NormalizeChuShengNianYue(p.CanJiaGongZuoShiJian));

            cmd.Parameters.AddWithValue("@MinZu", p.MinZu ?? "");
            cmd.Parameters.AddWithValue("@JiGuan", p.JiGuan ?? "");
            cmd.Parameters.AddWithValue("@ChuShengDi", p.ChuShengDi ?? "");
            cmd.Parameters.AddWithValue("@JianKangZhuangKuang", p.JianKangZhuangKuang ?? "");
            cmd.Parameters.AddWithValue("@ZhuanYeJiShuZhiWu", p.ZhuanYeJiShuZhiWu ?? "");
            cmd.Parameters.AddWithValue("@ShuXiZhuanYeYouHeZhuanChang", p.ShuXiZhuanYeYouHeZhuanChang ?? "");

            cmd.Parameters.AddWithValue("@QuanRiZhiJiaoYu_XueLi", p.QuanRiZhiJiaoYu_XueLi ?? "");
            cmd.Parameters.AddWithValue("@QuanRiZhiJiaoYu_XueWei", p.QuanRiZhiJiaoYu_XueWei ?? "");
            cmd.Parameters.AddWithValue("@QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi", p.QuanRiZhiJiaoYu_XueLi_BiYeYuanXiaoXi ?? "");
            cmd.Parameters.AddWithValue("@QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi", p.QuanRiZhiJiaoYu_XueWei_BiYeYuanXiaoXi ?? "");

            cmd.Parameters.AddWithValue("@ZaiZhiJiaoYu_XueLi", p.ZaiZhiJiaoYu_XueLi ?? "");
            cmd.Parameters.AddWithValue("@ZaiZhiJiaoYu_XueWei", p.ZaiZhiJiaoYu_XueWei ?? "");
            cmd.Parameters.AddWithValue("@ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi", p.ZaiZhiJiaoYu_XueLi_BiYeYuanXiaoXi ?? "");
            cmd.Parameters.AddWithValue("@ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi", p.ZaiZhiJiaoYu_XueWei_BiYeYuanXiaoXi ?? "");

            cmd.Parameters.AddWithValue("@XianRenZhiWu", p.XianRenZhiWu ?? "");
            cmd.Parameters.AddWithValue("@NiRenZhiWu", p.NiRenZhiWu ?? "");
            cmd.Parameters.AddWithValue("@NiMianZhiWu", p.NiMianZhiWu ?? "");

            cmd.Parameters.AddWithValue("@JianLi", p.JianLi ?? "");
            cmd.Parameters.AddWithValue("@JiangChengQingKuang", p.JiangChengQingKuang ?? "");
            cmd.Parameters.AddWithValue("@NianDuKaoHeJieGuo", p.NianDuKaoHeJieGuo ?? "");
            cmd.Parameters.AddWithValue("@RenMianLiYou", p.RenMianLiYou ?? "");

            cmd.Parameters.AddWithValue("@JiaTingChengYuan", p.JiaTingChengYuanJson ?? "");
            cmd.Parameters.AddWithValue("@ChengBaoDanWei", p.ChengBaoDanWei ?? "");
            cmd.Parameters.AddWithValue("@JiSuanNianLingShiJian", p.JiSuanNianLingShiJian ?? "");
            cmd.Parameters.AddWithValue("@TianBiaoShiJian", p.TianBiaoShiJian ?? "");
            cmd.Parameters.AddWithValue("@TianBiaoRen", p.TianBiaoRen ?? "");

            cmd.Parameters.AddWithValue("@ZhaoPian", (object?)photoBytes ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Version", p.Version ?? "");

            cmd.Parameters.AddWithValue("@NianLing", ""); // 如需可根据出生年月计算
            cmd.Parameters.AddWithValue("@XiuGaiShiJian", xiuGai);
            if (chuangJian != null)
                cmd.Parameters.AddWithValue("@ChuangJianShiJian", chuangJian);

            cmd.Parameters.AddWithValue("@DanWeiMingCheng", p.DanWeiMingCheng ?? "");
            cmd.Parameters.AddWithValue("@DangPaiMingCheng", p.DangPaiMingCheng ?? "");
        }





        public void UpsertKsJiating(string shenFenZheng, string jiaTingChengYuanJson)
        {
            if (Connection == null)
            {
                MSG.WriteLine("数据库连接为空，无法导入家庭成员。");
                return;
            }

            JArray arr = string.IsNullOrWhiteSpace(jiaTingChengYuanJson) ? new JArray() : JArray.Parse(jiaTingChengYuanJson);
            int totalCount = 15; // 固定生成 15 条
            int index = 1;

            using (var tran = Connection.BeginTransaction())
            {
                try
                {
                    // 1. 删除旧的家庭成员记录（在事务里）
                    using (var delCmd = new SQLiteCommand("DELETE FROM ksjiating WHERE ShenFenZheng=@sfz;", Connection, tran))
                    {
                        delCmd.Parameters.AddWithValue("@sfz", shenFenZheng ?? "");
                        delCmd.ExecuteNonQuery();
                    }

                    // 2. 插入新数据（实际成员 + 补齐空记录）
                    using (var insCmd = new SQLiteCommand(@"
                        INSERT INTO ksjiating (
                            ShenFenZheng, PaiXuId, ChengWei, XingMing, ChuShengRiQi, ZhengZhiMianMao, GongZuoDanWeiJiZhiWu
                        ) VALUES (
                            @ShenFenZheng, @PaiXuId, @ChengWei, @XingMing, @ChuShengRiQi, @ZhengZhiMianMao, @GongZuoDanWeiJiZhiWu
                        );", Connection, tran))
                    {
                        insCmd.Parameters.Add("@ShenFenZheng", System.Data.DbType.String);
                        insCmd.Parameters.Add("@PaiXuId", System.Data.DbType.Int32);
                        insCmd.Parameters.Add("@ChengWei", System.Data.DbType.String);
                        insCmd.Parameters.Add("@XingMing", System.Data.DbType.String);
                        insCmd.Parameters.Add("@ChuShengRiQi", System.Data.DbType.String);
                        insCmd.Parameters.Add("@ZhengZhiMianMao", System.Data.DbType.String);
                        insCmd.Parameters.Add("@GongZuoDanWeiJiZhiWu", System.Data.DbType.String);

                        // 插入实际成员
                        foreach (var item in arr)
                        {
                            if (index > totalCount) break;

                            insCmd.Parameters["@ShenFenZheng"].Value = shenFenZheng ?? "";
                            insCmd.Parameters["@PaiXuId"].Value = index;
                            insCmd.Parameters["@ChengWei"].Value = (string?)item["ChengWei"] ?? "";
                            insCmd.Parameters["@XingMing"].Value = (string?)item["XingMing"] ?? "";
                            insCmd.Parameters["@ChuShengRiQi"].Value = DateNormalizer.NormalizeChuShengNianYue((string?)item["ChuShengRiQi"]);

                            insCmd.Parameters["@ZhengZhiMianMao"].Value = (string?)item["ZhengZhiMianMao"] ?? "";
                            insCmd.Parameters["@GongZuoDanWeiJiZhiWu"].Value = (string?)item["GongZuoDanWeiJiZhiWu"] ?? "";
                            insCmd.ExecuteNonQuery();

                            index++;
                        }

                        // 补齐空记录
                        while (index <= totalCount)
                        {
                            insCmd.Parameters["@ShenFenZheng"].Value = shenFenZheng ?? "";
                            insCmd.Parameters["@PaiXuId"].Value = index;
                            insCmd.Parameters["@ChengWei"].Value = "";
                            insCmd.Parameters["@XingMing"].Value = "";
                            insCmd.Parameters["@ChuShengRiQi"].Value = "";
                            insCmd.Parameters["@ZhengZhiMianMao"].Value = "";
                            insCmd.Parameters["@GongZuoDanWeiJiZhiWu"].Value = "";
                            insCmd.ExecuteNonQuery();

                            index++;
                        }
                    }

                    // 3. 提交事务
                    tran.Commit();
                    MSG.WriteLine($"身份证 {shenFenZheng} 的家庭成员已更新，共 {totalCount} 条（实际 {arr.Count} 条，补齐 {totalCount - arr.Count} 条）。");
                }
                catch (Exception ex)
                {
                    // 出错时回滚事务
                    tran.Rollback();
                    MSG.WriteLine($"导入家庭成员失败，已回滚事务。错误信息: {ex.Message}");
                }
            }
        }



        // 更新或添加简历条目//
        public void UpsertKsJianLi(string shenFenZheng, string jianliText)
        {
            if (Connection == null)
            {
                MSG.WriteLine("数据库连接为空，无法导入简历。");
                return;
            }

            var items = NewJianLiParser.Parse(jianliText ?? "");

            // 确保解析项按顺序有正确的 PaiXuId（从1开始）
            for (int i = 0; i < items.Count; i++)
            {
                items[i].PaiXuId = i + 1;
            }

            const int totalCount = 15; // 每人固定 15 条
            using (var tran = Connection.BeginTransaction())
            {
                try
                {
                    // 1. 删除旧记录
                    using (var delCmd = new SQLiteCommand("DELETE FROM ksjianli WHERE ShenFenZheng=@sfz;", Connection, tran))
                    {
                        delCmd.Parameters.AddWithValue("@sfz", shenFenZheng ?? "");
                        delCmd.ExecuteNonQuery();
                    }

                    // 2. 插入新记录（保持输入顺序，PaiXuId从1递增）
                    using (var insCmd = new SQLiteCommand(@"
                            INSERT INTO ksjianli (
                                ShenFenZheng, PaiXuId, QiShiShiJian_NianYue, JieShuShiJian_NianYue, JianLiNeiRong
                            )
                            VALUES (
                                @ShenFenZheng, @PaiXuId, @QiShiShiJian_NianYue, @JieShuShiJian_NianYue, @JianLiNeiRong
                            );
                        ", Connection, tran))
                    {
                        // 保持你原来的参数定义方式
                        insCmd.Parameters.Add("@ShenFenZheng", DbType.String);
                        insCmd.Parameters.Add("@PaiXuId", DbType.Int32);
                        insCmd.Parameters.Add("@QiShiShiJian_NianYue", DbType.String);
                        insCmd.Parameters.Add("@JieShuShiJian_NianYue", DbType.String);
                        insCmd.Parameters.Add("@JianLiNeiRong", DbType.String);

                        // 插入解析到的真实条目
                        foreach (var item in items)
                        {
                            insCmd.Parameters["@ShenFenZheng"].Value = shenFenZheng ?? "";
                            insCmd.Parameters["@PaiXuId"].Value = item.PaiXuId;
                            insCmd.Parameters["@QiShiShiJian_NianYue"].Value = string.IsNullOrWhiteSpace(item.StartDate) ? "" : item.StartDate;
                            insCmd.Parameters["@JieShuShiJian_NianYue"].Value = string.IsNullOrWhiteSpace(item.EndDate) ? "" : item.EndDate;
                            insCmd.Parameters["@JianLiNeiRong"].Value = item.Content ?? "";
                            insCmd.ExecuteNonQuery();
                        }

                        // 3. 若不足 15 条，补足占位记录（只填证件号和 PaiXuId，其他字段为空字符串）
                        int currentCount = items.Count;
                        if (currentCount < totalCount)
                        {
                            for (int i = currentCount + 1; i <= totalCount; i++)
                            {
                                insCmd.Parameters["@ShenFenZheng"].Value = shenFenZheng ?? "";
                                insCmd.Parameters["@PaiXuId"].Value = i;
                                insCmd.Parameters["@QiShiShiJian_NianYue"].Value = "";
                                insCmd.Parameters["@JieShuShiJian_NianYue"].Value = "";
                                insCmd.Parameters["@JianLiNeiRong"].Value = "";
                                insCmd.ExecuteNonQuery();
                            }
                        }
                    }

                    tran.Commit();

                    int actual = items.Count;
                    int filled = Math.Max(0, totalCount - actual);
                    MSG.WriteLine($"身份证 {shenFenZheng} 的简历已更新，共 {totalCount} 条（实际 {actual} 条，补齐 {filled} 条）。");
                }
                catch (Exception ex)
                {
                    try { tran.Rollback(); } catch { }
                    MSG.WriteLine($"导入简历失败，已回滚事务。错误信息: {ex.Message}");
                }
            }
        }




        // 批量更新退休信息//
        public void UpdateAllRetirementInfo(ref string OutUpdateMessage)
        {
            if (Connection == null)
            {
                MSG.WriteLine("数据库连接为空，无法更新退休信息。");
                return;
            }
            OutUpdateMessage = "";
            int TemCount = 0;
            int SkipCount = 0;

            using (var tran = Connection.BeginTransaction())
            {
                try
                {
                    using (var cmd = new SQLiteCommand(
                        "SELECT ShenFenZheng, XingBie, GanBuJiBie, JiShuZhiWuJiBie, ChuShengNianYue FROM kslist;",
                        Connection, tran))
                    using (var reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            string sfz = reader["ShenFenZheng"]?.ToString() ?? "";
                            string xingbie = reader["XingBie"]?.ToString() ?? "";
                            string ganbuJibie = reader["GanBuJiBie"]?.ToString() ?? "";
                            string jishuZhiwuJibie = reader["JiShuZhiWuJiBie"]?.ToString() ?? "";
                            string chushengNianYue = reader["ChuShengNianYue"]?.ToString() ?? "";

                            // 性别调整规则（参考 Delphi 前端）
                            if (xingbie == "女")
                            {
                                if (ganbuJibie == "正局级" || ganbuJibie == "副局级" ||
                                    ganbuJibie == "市管一级调研员" || ganbuJibie == "正处级" ||
                                    ganbuJibie == "副处级" || ganbuJibie == "一级调研员" ||
                                    ganbuJibie == "二级调研员" || ganbuJibie == "三级调研员" ||
                                    ganbuJibie == "四级调研员" || jishuZhiwuJibie == "教师序列正高级" ||
                                    jishuZhiwuJibie == "教师序列副高级" || jishuZhiwuJibie == "非教师序列正高级" ||
                                    jishuZhiwuJibie == "非教师序列副高级")
                                {
                                    xingbie = "男";
                                }
                            }

                            try
                            {
                                // 调用已有的 CalculateRetirementDate
                                DataProcedureHelper.CalculateRetirementDate(
                                    xingbie, "干部", chushengNianYue,
                                    out string tuiXiuRiQi, out int tuiXiuNianLing, out string tuiXiuNianYue);

                                // 更新数据库
                                using (var upd = new SQLiteCommand(@"
                            UPDATE kslist
                            SET GaiGeTuiXiuShiJian=@sj,
                                GaiGeTuiXiuNianLing=@nl,
                                GaiGeTuiXiuNianYue=@ny
                            WHERE ShenFenZheng=@sfz;", Connection, tran))
                                {
                                    upd.Parameters.AddWithValue("@sj", tuiXiuRiQi ?? "");
                                    upd.Parameters.AddWithValue("@nl", tuiXiuNianLing);
                                    upd.Parameters.AddWithValue("@ny", tuiXiuNianYue ?? "");
                                    upd.Parameters.AddWithValue("@sfz", sfz);
                                    upd.ExecuteNonQuery();
                                }

                                TemCount++;
                            }
                            catch (Exception exOne)
                            {
                                SkipCount++;
                                MSG.WriteLine($"身份证 {sfz} 的退休信息计算失败，已跳过。原因: {exOne.Message}");
                                // 不抛出异常，继续下一条
                            }
                        }
                    }

                    tran.Commit();
                    OutUpdateMessage = $@"所有人员退休信息已批量更新完成。成功更新 {TemCount} 条，跳过 {SkipCount} 条。";
                    MSG.WriteLine(OutUpdateMessage);
                }
                catch (Exception ex)
                {
                    tran.Rollback();
                    OutUpdateMessage = $"批量更新退休信息失败，已回滚事务。错误信息: {ex.Message}";
                    MSG.WriteLine(OutUpdateMessage);
                }
            }
        }







        public void ImportXmlFileToDwDb(string xmlPath, PostLocalDataClass LocalDataObj = null)
        {
            try
            {
                // 1. 解析 XML → PersonDto
                var dto = XmlPersonParser.ParseFromXml(xmlPath);

                // 2. 检查身份证号是否为空或缺失
                if (string.IsNullOrWhiteSpace(dto.ShenFenZheng))
                {
                    string fileName = Path.GetFileName(xmlPath);
                    MSG.WriteLine($"导入失败：XML 文件 {fileName} 中身份证号缺失或为空，已跳过。");
                    return;
                }

                PostLocalDataClass TemLocalDataObj = LocalDataObj ?? new PostLocalDataClass();
                dto.DangPaiMingCheng = TemLocalDataObj.DangPaiMingCheng;
                dto.DanWeiMingCheng = TemLocalDataObj.DanWeiMingCheng;
                TemLocalDataObj = null;

                // 3. 插入或更新 kslist（直接用当前实例）
                this.UpsertKslist(dto);

                // 4. 插入或更新 ksjiating
                this.UpsertKsJiating(dto.ShenFenZheng, dto.JiaTingChengYuanJson);

                // 简历解析并入库（保持输入顺序，空行跳过，PaiXuId从1递增）
                this.UpsertKsJianLi(dto.ShenFenZheng, dto.JianLi);


                MSG.WriteLine($"成功导入或更新记录：{dto.XingMing} ({dto.ShenFenZheng})");
            }
            catch (Exception ex)
            {
                MSG.WriteLine($"导入失败: {ex.Message}");
            }
        }




        //导出到docx或pdf文件//
        public void ExportPersonToDocxWithPhoto(string sfz, string templatePath, string outputPath)
        {
            string ConvertDateToYearMonth(string inputDate)
            {
                try
                {
                    DateTime dt = DateTime.ParseExact(inputDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                    return dt.ToString("yyyy.MM");
                }
                catch
                {
                    return "";
                }
            }

            if (Connection == null)
            {
                MSG.WriteLine("数据库连接为空，无法导出。");
                return;
            }

            try
            {
                using (var cmd = new SQLiteCommand(
                    "SELECT * FROM kslist WHERE ShenFenZheng=@sfz;", Connection))
                {
                    cmd.Parameters.AddWithValue("@sfz", sfz);
                    using (var reader = cmd.ExecuteReader())
                    {
                        if (!reader.Read())
                        {
                            MSG.WriteLine($"未找到身份证号 {sfz} 的记录。");
                            return;
                        }

                        // 1. 加载模板
                        Aspose.Words.Document doc = new Aspose.Words.Document(templatePath);
                        DocumentBuilder builder = new DocumentBuilder(doc);

                        // 2. 替换文本字段
                        for (int i = 0; i < reader.FieldCount; i++)
                        {
                            string fieldName = reader.GetName(i);
                            if (fieldName == "ZhaoPian") continue; // 照片单独处理  
                            if (fieldName == "JianLi"){
                                string fieldValue1 = reader["JianLi"]?.ToString() ?? "";
                                string[] lines = fieldValue1.Split(new[] { "\r\n", "\n" }, StringSplitOptions.None);
                                builder.MoveToBookmark("JianLiBookmark"); // 推荐用书签方式
                                foreach (string line in lines)
                                {
                                    builder.Writeln(line); // 每行写入并换行
                                }
                                continue;
                            }

                            string fieldValue = reader[i]?.ToString() ?? "";
                            //分别处理//
                            if( (fieldName == "ChuShengNianYue") ||
                                (fieldName == "RuDangShiJian")   ||
                                (fieldName == "CanJiaGongZuoShiJian") ||
                                (fieldName == "GaiGeTuiXiuShiJian")
                            )
                            {
                                fieldValue = ConvertDateToYearMonth(fieldValue);
                            }
                            if (fieldName == "NianLing")
                            {
                                fieldValue = fieldValue + "岁";
                            }
                            doc.Range.Replace($"{{{fieldName}}}", fieldValue, new FindReplaceOptions());
                        }

                        // 3. 替换书签为照片
                        if (!(reader["ZhaoPian"] is DBNull))
                        {
                            byte[] photoBytes = (byte[])reader["ZhaoPian"];
                            if (photoBytes.Length > 0)
                            {
                                using (MemoryStream ms = new MemoryStream(photoBytes))
                                {
                                    Bookmark bm = doc.Range.Bookmarks["ZhaoPianBookmark"];
                                    if (bm != null)
                                    {
                                        // 清空书签内容
                                        bm.Text = "";

                                        // 移动到书签位置
                                        builder.MoveToBookmark("ZhaoPianBookmark", true, true);
                                        builder.InsertImage(ms, 100, 120);
                                    }
                                    else
                                    {
                                        MSG.WriteLine("模板中未找到书签 'ZhaoPianBookmark'");
                                    }
                                }
                            }
                        }

                        // 4. 查询家庭成员信息并填充书签
                        using (var cmdFamily = new SQLiteCommand(
                            "SELECT * FROM ksjiating WHERE ShenFenZheng=@sfz ORDER BY PaiXuId LIMIT 7;", Connection))
                        {
                            cmdFamily.Parameters.AddWithValue("@sfz", sfz);
                            using (var readerFamily = cmdFamily.ExecuteReader())
                            {
                                int index = 1;
                                while (index <= 7)
                                {
                                    string chengWei = "";
                                    string xingMing = "";
                                    string nianLing = "";
                                    string zhengZhiMianMao = "";
                                    string gongZuoDanWeiJiZhiWu = "";

                                    if (readerFamily.Read())
                                    {
                                        chengWei = readerFamily["ChengWei"]?.ToString() ?? "";
                                        xingMing = readerFamily["XingMing"]?.ToString() ?? "";
                                        string chuShengRiQi = readerFamily["ChuShengRiQi"]?.ToString() ?? "";
                                        if (DateTime.TryParse(chuShengRiQi, out DateTime birth))
                                        {
                                            int age = DateTime.Now.Year - birth.Year;
                                            if (DateTime.Now < birth.AddYears(age)) age--;
                                            nianLing = age.ToString() + "岁";
                                        }
                                        zhengZhiMianMao = readerFamily["ZhengZhiMianMao"]?.ToString() ?? "";
                                        gongZuoDanWeiJiZhiWu = readerFamily["GongZuoDanWeiJiZhiWu"]?.ToString() ?? "";
                                    }

                                    // 写入书签（存在才写）
                                    if (doc.Range.Bookmarks[$"ChengWei{index}"] != null)
                                    {
                                        builder.MoveToBookmark($"ChengWei{index}");
                                        builder.Write(chengWei);
                                    }
                                    if (doc.Range.Bookmarks[$"XingMing{index}"] != null)
                                    {
                                        builder.MoveToBookmark($"XingMing{index}");
                                        builder.Write(xingMing);
                                    }
                                    if (doc.Range.Bookmarks[$"NianLing{index}"] != null)
                                    {
                                        builder.MoveToBookmark($"NianLing{index}");
                                        builder.Write(nianLing);
                                    }
                                    if (doc.Range.Bookmarks[$"ZhengZhiMianMao{index}"] != null)
                                    {
                                        builder.MoveToBookmark($"ZhengZhiMianMao{index}");
                                        builder.Write(zhengZhiMianMao);
                                    }
                                    if (doc.Range.Bookmarks[$"GongZuoDanWeiJiZhiWu{index}"] != null)
                                    {
                                        builder.MoveToBookmark($"GongZuoDanWeiJiZhiWu{index}");
                                        builder.Write(gongZuoDanWeiJiZhiWu);
                                    }

                                    index++;
                                }
                            }
                        }

                        // 5. 保存结果
                        doc.Save(outputPath, SaveFormat.Docx);
                        MSG.WriteLine($"人员 {sfz} 的信息已成功导出到 {outputPath}");
                    }
                }
            }
            catch (Exception ex)
            {
                MSG.WriteLine($"导出失败: {ex.Message}");
            }
        }

    } // end class DataModle





    public static class DateNormalizer
    {
        public static string NormalizeChuShengNianYue(string? input)
        {
            if (string.IsNullOrWhiteSpace(input)) return "";

            string s = input.Trim();

            // 统一分隔符
            s = s.Replace("年", "/").Replace("月", "/").Replace("日", "")
                 .Replace(".", "/").Replace("-", "/").Replace("//", "/");

            // 纯数字情况
            if (Regex.IsMatch(s, @"^\d{8}$")) // yyyyMMdd
            {
                if (DateTime.TryParseExact(s, "yyyyMMdd", CultureInfo.InvariantCulture,
                    DateTimeStyles.None, out var dt))
                    return dt.ToString("yyyy-MM-dd");
            }
            if (Regex.IsMatch(s, @"^\d{6}$")) // yyyyMM
            {
                if (DateTime.TryParseExact(s, "yyyyMM", CultureInfo.InvariantCulture,
                    DateTimeStyles.None, out var dt))
                    return new DateTime(dt.Year, dt.Month, 1).ToString("yyyy-MM-dd");
            }
            if (Regex.IsMatch(s, @"^\d{4}$")) // yyyy
            {
                if (int.TryParse(s, out var year))
                    return new DateTime(year, 1, 1).ToString("yyyy-MM-dd");
            }

            // 分隔符情况 (支持 /)
            var parts = s.Split('/', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2)
            {
                if (int.TryParse(parts[0], out var y) &&
                    int.TryParse(parts[1], out var m))
                {
                    y = NormalizeYear(y);
                    int d = (parts.Length >= 3 && int.TryParse(parts[2], out var day)) ? day : 1;
                    try
                    {
                        return new DateTime(y, m, d).ToString("yyyy-MM-dd");
                    }
                    catch { return ""; }
                }
            }
            else if (parts.Length == 1)
            {
                if (int.TryParse(parts[0], out var y))
                {
                    y = NormalizeYear(y);
                    return new DateTime(y, 1, 1).ToString("yyyy-MM-dd");
                }
            }

            // 正则匹配中文格式
            var m1 = Regex.Match(input, @"^(?<year>\d{2,4})年(?<month>\d{1,2})月(?<day>\d{1,2})?$");
            if (m1.Success)
            {
                int y = NormalizeYear(int.Parse(m1.Groups["year"].Value));
                int m = int.Parse(m1.Groups["month"].Value);
                int d = m1.Groups["day"].Success ? int.Parse(m1.Groups["day"].Value) : 1;
                return new DateTime(y, m, d).ToString("yyyy-MM-dd");
            }

            var m2 = Regex.Match(input, @"^(?<year>\d{2,4})年(?<month>\d{1,2})$");
            if (m2.Success)
            {
                int y = NormalizeYear(int.Parse(m2.Groups["year"].Value));
                int m = int.Parse(m2.Groups["month"].Value);
                return new DateTime(y, m, 1).ToString("yyyy-MM-dd");
            }

            var m3 = Regex.Match(input, @"^(?<year>\d{2,4})年$");
            if (m3.Success)
            {
                int y = NormalizeYear(int.Parse(m3.Groups["year"].Value));
                return new DateTime(y, 1, 1).ToString("yyyy-MM-dd");
            }

            // 如果都不匹配，返回空字符串
            return "";
        }

        private static int NormalizeYear(int year)
        {
            if (year < 100)
            {
                if (year <= 29) return 2000 + year; // 00–29 → 2000–2029
                else return 1900 + year;            // 30–99 → 1930–1999
            }
            return year;
        }
    }





    public class JianLiItem
    {
        public int PaiXuId { get; set; }
        public string StartDate { get; set; } = "";
        public string EndDate { get; set; } = "";
        public string Content { get; set; } = "";
    }

    public static class NewJianLiParser
    {
        private static readonly Regex[] DatePatterns = new[]
        {
        new Regex(@"\b(?<y>\d{4})[ \-./](?<m>\d{1,2})[ \-./](?<d>\d{1,2})\b", RegexOptions.Compiled),
        new Regex(@"\b(?<y>\d{4})[ \-./](?<m>\d{1,2})\b", RegexOptions.Compiled),
        new Regex(@"\b(?<y2>\d{2})[.](?<m>\d{1,2})[.](?<d>\d{1,2})\b", RegexOptions.Compiled),
        new Regex(@"\b(?<y>\d{4})年\s*(?<m>\d{1,2})月(?:\s*(?<d>\d{1,2})日?)?\b", RegexOptions.Compiled),
        new Regex(@"\b(?<y>\d{4})[.\/\-](?<m>\d{1,2})\b", RegexOptions.Compiled),
        new Regex(@"\b(?<m>\d{1,2})[.\/\-](?<d>\d{1,2})\b", RegexOptions.Compiled)
    };

        private static readonly Regex SepRegex = new Regex(@"(--+|—+|至|到|~|(?<!\d)-(?!\d))", RegexOptions.Compiled);

        // TryParseLine: 增强后支持只有 start、start+sep(无end)、以及 start+content（无sep无end）
        private static bool TryParseLine(string line, out string start, out string end, out string content)
        {
            start = end = content = "";

            // 1) 找第一个日期 token（最左）
            var first = FindFirstDate(line);
            if (first == null) return false;
            start = first.Value.Text;
            int posAfterStart = first.Value.Index + first.Value.Length;

            // 2) 优先寻找显式分隔符（限制距离，避免误判）
            var sepMatch = SepRegex.Match(line, posAfterStart);
            if (sepMatch.Success && sepMatch.Index - posAfterStart <= 40)
            {
                int posAfterSep = sepMatch.Index + sepMatch.Length;
                // 在分隔符之后寻找第二个日期
                var second = FindFirstDate(line, posAfterSep);
                if (second != null)
                {
                    // 正常 start -- end ... 的情况
                    end = second.Value.Text;
                    int posAfterEnd = second.Value.Index + second.Value.Length;
                    content = line.Substring(posAfterEnd).Trim();
                    if (string.IsNullOrEmpty(content)) content = "";
                    return true;
                }
                else
                {
                    // 分隔符存在但没有第二个日期：允许视为“至今”情况
                    // 内容为分隔符之后的剩余文本（可能为空）
                    content = line.Substring(posAfterSep).Trim();
                    // 即便 content 为空，也允许（表示 start 到现在且无描述）
                    end = "";
                    return true;
                }
            }

            // 3) 没有显式分隔符，尝试空格分隔的两个日期（两个日期之间仅有空白或少量连字符）
            var secondAlt = FindFirstDate(line, posAfterStart);
            if (secondAlt != null)
            {
                int betweenLen = secondAlt.Value.Index - posAfterStart;
                if (betweenLen >= 0 && betweenLen <= 12)
                {
                    string between = line.Substring(posAfterStart, betweenLen);
                    if (Regex.IsMatch(between, @"^[\s\-–—]{1,12}$"))
                    {
                        end = secondAlt.Value.Text;
                        int posAfterEnd = secondAlt.Value.Index + secondAlt.Value.Length;
                        content = line.Substring(posAfterEnd).Trim();
                        if (string.IsNullOrEmpty(content)) content = "";
                        return true;
                    }
                }
            }

            // 4) 没有第二个日期，也没有显式分隔符：如果第一个日期后直接是内容（允许若干空白），则视为只有开始日期
            //    例如: "2009.11    华师大公共管理研究院..."
            var restAfterStart = line.Substring(posAfterStart).Trim();
            if (!string.IsNullOrEmpty(restAfterStart))
            {
                // 但要避免把非常短的尾部误判为内容（可根据需要调整阈值）
                // 这里认为只要第一个日期后有非空文本，就把它当作 content（且 end 为空）
                end = "";
                content = restAfterStart;
                return true;
            }

            // 5) 兜底失败
            return false;
        }

        public static List<JianLiItem> Parse(string input)
        {
            var list = new List<JianLiItem>();
            if (string.IsNullOrWhiteSpace(input)) return list;

            var lines = input.Split(new[] { "\r\n", "\n" }, StringSplitOptions.None);
            int idx = 1;
            foreach (var raw in lines)
            {
                var line = raw.Trim();
                if (string.IsNullOrEmpty(line)) continue;

                if (TryParseLine(line, out string sRaw, out string eRaw, out string cont))
                {
                    list.Add(new JianLiItem
                    {
                        PaiXuId = idx++,
                        StartDate = NormalizeDate(sRaw),
                        EndDate = string.IsNullOrWhiteSpace(eRaw) ? "" : NormalizeDate(eRaw),
                        Content = cont.Trim()
                    });
                }
                else
                {
                    list.Add(new JianLiItem
                    {
                        PaiXuId = idx++,
                        StartDate = "",
                        EndDate = "",
                        Content = line
                    });
                }
            }

            return list;
        }

        private static (string Text, int Index, int Length)? FindFirstDate(string text, int startAt = 0)
        {
            int bestIndex = int.MaxValue;
            string bestText = null;
            int bestLen = 0;

            for (int i = 0; i < DatePatterns.Length; i++)
            {
                var m = DatePatterns[i].Match(text, startAt);
                if (m.Success)
                {
                    if (m.Index < bestIndex)
                    {
                        bestIndex = m.Index;
                        bestText = m.Value;
                        bestLen = m.Length;
                    }
                }
            }

            if (bestText == null) return null;
            return (bestText, bestIndex, bestLen);
        }

        // NormalizeDate 与 MapTwoDigitYear、SafeFormat 保持之前实现（略）
        private static string NormalizeDate(string raw)
        {
            if (string.IsNullOrWhiteSpace(raw)) return "";

            raw = raw.Trim();
            var m = Regex.Match(raw, @"^(?<y>\d{4})年\s*(?<m>\d{1,2})月(?:\s*(?<d>\d{1,2})日?)?$");
            if (m.Success)
            {
                int y = int.Parse(m.Groups["y"].Value);
                int mm = int.Parse(m.Groups["m"].Value);
                int dd = m.Groups["d"].Success ? int.Parse(m.Groups["d"].Value) : 1;
                return SafeFormat(y, mm, dd);
            }

            m = Regex.Match(raw, @"^(?<y>\d{4})[ \-./](?<m>\d{1,2})(?:[ \-./](?<d>\d{1,2}))?$");
            if (m.Success)
            {
                int y = int.Parse(m.Groups["y"].Value);
                int mm = int.Parse(m.Groups["m"].Value);
                int dd = m.Groups["d"].Success ? int.Parse(m.Groups["d"].Value) : 1;
                return SafeFormat(y, mm, dd);
            }

            m = Regex.Match(raw, @"^(?<y2>\d{2})[.](?<m>\d{1,2})[.](?<d>\d{1,2})$");
            if (m.Success)
            {
                int y2 = int.Parse(m.Groups["y2"].Value);
                int y = MapTwoDigitYear(y2);
                int mm = int.Parse(m.Groups["m"].Value);
                int dd = int.Parse(m.Groups["d"].Value);
                return SafeFormat(y, mm, dd);
            }

            m = Regex.Match(raw, @"^(?<y>\d{4})[.\/\-](?<m>\d{1,2})$");
            if (m.Success)
            {
                int y = int.Parse(m.Groups["y"].Value);
                int mm = int.Parse(m.Groups["m"].Value);
                return SafeFormat(y, mm, 1);
            }

            if (DateTime.TryParse(raw, CultureInfo.InvariantCulture, DateTimeStyles.None, out var dt))
            {
                return dt.ToString("yyyy-MM-dd");
            }

            return raw;
        }

        private static int MapTwoDigitYear(int y2)
        {
            if (y2 >= 0 && y2 <= 29) return 2000 + y2;
            return 1900 + y2;
        }

        private static string SafeFormat(int y, int m, int d)
        {
            try
            {
                int daysInMonth = DateTime.DaysInMonth(y, Math.Max(1, Math.Min(12, m)));
                int dd = Math.Max(1, Math.Min(daysInMonth, d));
                var dt = new DateTime(y, Math.Max(1, Math.Min(12, m)), dd);
                return dt.ToString("yyyy-MM-dd");
            }
            catch
            {
                return $"{y:0000}-{m:00}-{d:00}";
            }
        }
    }





    public static class DataProcedureHelper
    {


        /// <summary>
        /// 计算退休日期并通过输出参数返回退休日期字符串和退休时的整数年龄（周岁）以及"X岁Y个月"字符串。
        /// 输入 birthDateStr 格式: "yyyy-MM-dd" 或 "yyyy-MM"
        /// 输出 retirementDateStr 格式: "yyyy-MM-dd"
        /// 输出 retirementAge 为整数周岁
        /// 输出 retirementAgeMonthsStr 格式: "X岁Y个月"
        /// </summary>
        public static void CalculateRetirementDate(
            string gender,
            string positionType,
            string birthDateStr,
            out string retirementDateStr,
            out int retirementAge,
            out string retirementAgeMonthsStr)
        {
            DateTime PolicyStart = new DateTime(2025, 1, 1);
            // 初始化输出
            retirementDateStr = null;
            retirementAge = 0;
            retirementAgeMonthsStr = null;

            // 解析出生日期（精确到日），支持 yyyy-MM 或 yyyy-MM-dd
            birthDateStr = NormalizeDateManual(birthDateStr);
            if (!DateTime.TryParseExact(birthDateStr, "yyyy-MM-dd",
                CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime birthDate))
            {
                throw new ArgumentException("出生日期格式错误，应为 yyyy-MM-dd 或 yyyy-MM，例如 1977-09-19 或 1977-09");
            }

            // 确定基准年龄、步长和最大年龄
            int baseAge, delayStepMonths, maxAge;
            if (string.Equals(gender, "男", StringComparison.Ordinal))
            {
                baseAge = 60; delayStepMonths = 4; maxAge = 63;
            }
            else if (string.Equals(gender, "女", StringComparison.Ordinal) &&
                     string.Equals(positionType, "干部", StringComparison.Ordinal))
            {
                baseAge = 55; delayStepMonths = 4; maxAge = 58;
            }
            else if (string.Equals(gender, "女", StringComparison.Ordinal) &&
                     string.Equals(positionType, "工人", StringComparison.Ordinal))
            {
                baseAge = 50; delayStepMonths = 2; maxAge = 55;
            }
            else
            {
                throw new ArgumentException("性别或岗位类型输入错误。女性需指定岗位类型：\"干部\" 或 \"工人\"。");
            }

            // 原退休日（保留日）
            DateTime originalRetirement = birthDate.AddYears(baseAge);

            // 若原退休日在政策实施前，直接返回原退休日及对应年龄
            DateTime finalRetirement = originalRetirement;
            if (originalRetirement >= PolicyStart)
            {
                // 计算 policyStart 到 originalRetirement 的月份差（按包含制）
                int monthsSincePolicy = (originalRetirement.Year - PolicyStart.Year) * 12
                                      + (originalRetirement.Month - PolicyStart.Month);

                // 包含制：把退休当月也算入（多数线上计算器采用此方式）
                monthsSincePolicy += 1;
                if (monthsSincePolicy < 0) monthsSincePolicy = 0;

                // 计算延迟周期数（向上取整），每个周期增加1个月延迟
                int delayCycles = (int)Math.Ceiling((double)monthsSincePolicy / delayStepMonths);

                // 延迟月数上限
                int maxDelayMonths = (maxAge - baseAge) * 12;
                int delayMonths = Math.Min(delayCycles, maxDelayMonths);

                // 最终退休日
                finalRetirement = originalRetirement.AddMonths(delayMonths);
            }

            // 计算退休时的整数年龄（周岁）
            int age = finalRetirement.Year - birthDate.Year;
            if (finalRetirement < birthDate.AddYears(age)) age--;
            if (age < 0) age = 0;

            // 计算退休时的 年+月（用于 "X岁Y个月"）
            int years = finalRetirement.Year - birthDate.Year;
            int months = finalRetirement.Month - birthDate.Month;
            int days = finalRetirement.Day - birthDate.Day;

            if (days < 0)
            {
                // 借一个月
                DateTime prevMonth = finalRetirement.AddMonths(-1);
                int daysInPrevMonth = DateTime.DaysInMonth(prevMonth.Year, prevMonth.Month);
                days += daysInPrevMonth;
                months -= 1;
            }

            if (months < 0)
            {
                months += 12;
                years -= 1;
            }

            if (years < 0) years = 0;
            if (months < 0) months = 0;

            // 设置输出
            retirementDateStr = finalRetirement.ToString("yyyy-MM-dd");
            retirementAge = age;
            retirementAgeMonthsStr = $"{years}岁{months}个月";
            if(months<=0){
                retirementAgeMonthsStr = $"{years}岁";
            }
        }

        public static string NormalizeDateManual(string input)
        {
            try
            {
                string[] parts = input.Split('-');
                if (parts.Length == 2)
                {
                    // 输入只有 年-月，自动补充日为 "01"
                    string year = parts[0];
                    string month = parts[1].PadLeft(2, '0');
                    string day = "01";
                    return $"{year}-{month}-{day}";
                }
                else if (parts.Length == 3)
                {
                    // 输入 年-月-日
                    string year = parts[0];
                    string month = parts[1].PadLeft(2, '0');
                    string day = parts[2].PadLeft(2, '0');
                    return $"{year}-{month}-{day}";
                }
                else
                {
                    // 格式不对，返回空字符串
                    return string.Empty;
                }
            }
            catch
            {
                // 出错时静默返回空字符串
                return string.Empty;
            }
        }

    }



    //================================================================================// 


    public interface IDbHelpers
    {
        System.Data.SQLite.SQLiteConnection GetPhysicalDbConnection();
        System.Data.SQLite.SQLiteConnection GetInMemoryDbConnection();
    }

    public class DbHelpers : IDbHelpers
    {
        public readonly string dbFilePath = @$"{Environment.CurrentDirectory}\test.db";
        private System.Data.SQLite.SQLiteConnection inMemoryDbConnection = null;
        public DbHelpers()
        {

        }
        public System.Data.SQLite.SQLiteConnection GetPhysicalDbConnection()
        {
            var dbConnection = new System.Data.SQLite.SQLiteConnection("Data Source =" + dbFilePath + ";Mode=ReadWrite;Journal Mode=WAL;BusyTimeout=10000;");
            dbConnection.Open();
            return dbConnection;
        }

        public System.Data.SQLite.SQLiteConnection GetPhysicalDbConnection(string InLocalFile)
        {
            var dbConnection = new System.Data.SQLite.SQLiteConnection("Data Source =" + InLocalFile + ";Mode=ReadWriteCreate;Journal Mode=WAL;BusyTimeout=10000;");
            dbConnection.Open();
            return dbConnection;
        }

        public System.Data.SQLite.SQLiteConnection GetInMemoryDbConnection()
        {
            if (inMemoryDbConnection == null)
            {
                inMemoryDbConnection = new System.Data.SQLite.SQLiteConnection("Data Source=:memory:;Version=3;");
                inMemoryDbConnection.Open();
                return inMemoryDbConnection;
            }
            return inMemoryDbConnection;
        }

        public System.Data.SQLite.SQLiteConnection GetInMemoryDbConnection(byte[] Inbytes)
        {
            var conn = new System.Data.SQLite.SQLiteConnection("Data Source=:memory:;Version=3;New=True;");
            conn.Open();
            conn.Deserialize("main", Inbytes, false);
            return conn;
        }

        public System.Data.SQLite.SQLiteConnection CreateShareMemConnection(byte[] Inbytes, string DataBaseName = "sharedMem")
        {
            //共享缓存可用于 内存数据库，前提是该数据库是使用URI 文件名创建的
            //FullUri=file::memory:?cache=shared
            //FullUri=file:sharedMem?mode=memory&cache=shared;
            //Data Source=file:sharedMem?mode=memory&cache=shared
            //FullUri=file:/TEST;VfsName=memdb
            //string TemConnStr = $@"FullUri=file:{DataBaseName}?mode=memory&cache=shared";
            string TemConnStr = $@"FullUri=file:/{DataBaseName};VfsName=memdb;Journal Mode=WAL;BusyTimeout=30000;Synchronous=Normal;Max Pool Size=2000;Pooling=True;";
            //这个连接可以生成本地文件//
            //string TemConnStr = $@"FullUri=file:{DataBaseName};Journal Mode=WAL;BusyTimeout=30000;Synchronous=Normal;Max Pool Size=2000;Pooling=True;";
            var conn = new System.Data.SQLite.SQLiteConnection(TemConnStr);
            conn.Open();
            conn.Deserialize("main", Inbytes, false);
            var conn2 = new System.Data.SQLite.SQLiteConnection(TemConnStr);
            conn2.BusyTimeout = 30000;
            conn2.Open();
            //通过备份数据库来共享内存数据库内容//
            conn.BackupDatabase(conn2,
                      sourceName: "main",
                      destinationName: "main",
                      pages: -1,
                      callback: null,
                      retryMilliseconds: 0);
            conn.Close();
            conn.Dispose();
            return conn2;
        }

        public System.Data.SQLite.SQLiteConnection ShareMemConnection(string DataBaseName = "sharedMem")
        {
            //string TemConnStr = $@"FullUri=file:{DataBaseName}?mode=memory&cache=shared";
            string TemConnStr = $@"FullUri=file:/{DataBaseName};VfsName=memdb;Journal Mode=WAL;BusyTimeout=30000;Synchronous=Normal;Max Pool Size=2000;Pooling=True;";
            //这个连接可以生成本地文件//
            //string TemConnStr = $@"FullUri=file:{DataBaseName};Journal Mode=WAL;BusyTimeout=30000;Synchronous=Normal;Max Pool Size=2000;Pooling=True;";
            var conn = new System.Data.SQLite.SQLiteConnection(TemConnStr);
            conn.BusyTimeout = 30000;
            conn.Open();
            /*
            var csb = new SQLiteConnectionStringBuilder
            {
                DataSource = "test.db",
                Version = 3,
                BusyTimeout = 5000
            };
            */
            return conn;
        }


        public static string GetCreateTableSql(DataTable dt, string tableName)
        {
            var cols = new List<string>();
            foreach (DataColumn col in dt.Columns)
            {
                //Console.WriteLine($@"col.DataType:{col.DataType.Name}");
                string sqlType = col.DataType == typeof(int) ? "INTEGER"
                                : col.DataType == typeof(long) ? "INTEGER"
                                : col.DataType == typeof(bool) ? "INTEGER"
                                : col.DataType == typeof(double) ? "REAL"
                                : col.DataType == typeof(decimal) ? "REAL"
                                : col.DataType == typeof(byte[]) ? "BLOB"
                                : col.DataType == typeof(DateTime) ? "TEXT"
                                : col.DataType == typeof(string) ? "TEXT"
                                : "NUMERIC";

                var parts = new List<string> { $"\"{col.ColumnName}\"", sqlType };

                if (!col.AllowDBNull) parts.Add("NOT NULL");
                if (col.AutoIncrement) parts.Add("PRIMARY KEY AUTOINCREMENT");
                else if (dt.PrimaryKey.Contains(col))
                    parts.Add("PRIMARY KEY");

                cols.Add(string.Join(" ", parts));
            }

            return $"CREATE TABLE IF NOT EXISTS \"{tableName}\" (\n  "
                 + string.Join(",\n  ", cols)
                 + "\n);";
        }

        public static void BulkInsert(SQLiteConnection conn, DataTable dt, string tableName)
        {
            using (var tran = conn.BeginTransaction())
            {
                // 1. 创建新表
                using (var cmd = conn.CreateCommand())
                {
                    cmd.CommandText = GetCreateTableSql(dt, tableName);
                    cmd.ExecuteNonQuery();
                }

                // 2. 准备 INSERT 命令
                string colList = string.Join(", ", dt.Columns.Cast<DataColumn>().Select(c => $"\"{c.ColumnName}\""));
                string paramList = string.Join(", ", dt.Columns.Cast<DataColumn>().Select(c => $"@{c.ColumnName}"));
                string insertSql = $"INSERT INTO \"{tableName}\" ({colList}) VALUES ({paramList})";

                using (var insertCmd = conn.CreateCommand())
                {
                    insertCmd.CommandText = insertSql;
                    // 参数定义
                    foreach (DataColumn col in dt.Columns)
                        insertCmd.Parameters.Add(new SQLiteParameter($"@{col.ColumnName}", DbType.Object));
                    insertCmd.Prepare();

                    // 3. 遍历所有 DataRow
                    foreach (DataRow row in dt.Rows)
                    {
                        foreach (DataColumn col in dt.Columns)
                            insertCmd.Parameters[$"@{col.ColumnName}"].Value = row[col] ?? DBNull.Value;
                        insertCmd.ExecuteNonQuery();
                    }
                }

                // 4. 提交
                tran.Commit();
            }
        }
    }


    //================================================================================//




}
